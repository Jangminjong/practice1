<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="GoodsOrderDAO">
 	<resultMap type="goodsOrderDetailVO" id="goodsOrderDetailResult">
 		<result property="order_detail_seller" column="order_detail_seller"/>
 		<result property="order_detail_goods" column="order_detail_goods"/>
 		<result property="order_detail_category" column="order_detail_category"/>
 		<result property="order_detail_quantity" column="order_detail_quantity"/>
 		<result property="order_detail_option" column="order_detail_option1"/>
 		<result property="order_detail_donation" column="order_detail_donation"/>
 		<result property="order_detail_demand" column="order_detail_demand"/>
 		<result property="order_detail_price" column="order_detail_price"/>
 		<result property="coupon_use" column="coupon_use"/>
 		<result property="coupon_code" column="coupon_code"/>
 		<result property="order_detail_cost" column="order_detail_cost"/>
 		<result property="order_review" column="order_review"/>
 		<result property="order_id" column="order_id"/>
 		
 		<result property="order_detail_code" column="order_detail_code"/>
 		<result property="order_detail_payment" column="order_detail_payment"/>
 		<result property="goods_name" column="order_goods_name"/>
 		<result property="order_delivery_state" column="order_delivery_state"/>
 		<result property="order_date" column="order_date"/>
 		<result property="order_detail_name" column="order_detail_name"/>
 		<result property="order_detail_phone" column="order_detail_phone"/>
 		<result property="order_detail_zip" column="order_detail_zip"/>
 		<result property="order_detail_address" column="order_detail_address"/>
 		<result property="order_detail_address2" column="order_detail_address2"/>
 		<result property="imp_uid" column="imp_uid"/>
 		
 		<result property="store_name" column="store_name"/>
 		<result property="goods_photo" column="goods_photo" typeHandler="org.apache.ibatis.type.ArrayTypeHandler"/> 		
 	</resultMap>
 	
 	<resultMap type="goodsOrderVO" id="goodsOrderResult">
 		<result property="order_num" column="order_num"/>
 		<result property="order_detail_codes" column="order_detail_codes" typeHandler="org.apache.ibatis.type.ArrayTypeHandler"/>
 		<result property="order_detail_seller" column="order_detail_seller"/>
 		<result property="order_delivery_code" column="order_delivery_code"/>
 		<result property="order_payment_date" column="order_payment_date"/>
 		<result property="order_payment_check" column="order_payment_check"/>
 		<result property="order_id" column="order_id"/>
 		<result property="order_save" column="order_save"/>
 		<result property="order_save_use" column="order_save_use"/>
 		<result property="order_final_cost" column="order_final_cost"/>
 		<result property="marchant_uid" column="marchant_uid"/>
 		<result property="imp_uid" column="imp_uid"/>
 	</resultMap>
 	
 	<resultMap type="cartVO" id="cartResult">
 		<result property="cart_num" column="cart_num"/>
 		<result property="goods_code" column="goods_code"/>
 		<result property="seller_code" column="seller_code"/>
 		<result property="goods_price" column="goods_price"/>
 		<result property="cart_quantity" column="cart_quantity"/>
 		<result property="goods_option_value" column="goods_option_value" typeHandler="org.apache.ibatis.type.ArrayTypeHandler"/>
 		<result property="goods_option_price" column="goods_option_price" typeHandler="org.apache.ibatis.type.ArrayTypeHandler"/>
 		<result property="cart_delivery_fee" column="cart_delivery_fee"/>
 		<result property="cart_donation" column="cart_donation"/>
 		<result property="cart_save" column="cart_save"/>
 		<result property="user_id" column="user_id"/>
 		<result property="cart_pay_check" column="cart_pay_check"/>
 		<result property="cart_order_content" column="cart_order_content"/>
 		<result property="store_name" column="store_name"/>
 		<collection property="goodsVO" resultMap="goodsResult" />
 	</resultMap>
 	
 	<resultMap type="goodsVO" id="goodsResult">
 		<result property="goods_code" column="goods_code"/>
 		<result property="goods_name" column="goods_name"/>
 		<result property="goods_price" column="goods_price"/>
 		<result property="seller_code" column="seller_code"/>
 		<result property="goods_category" column="goods_category"/>
 		<result property="goods_photo" column="goods_photo" typeHandler="org.apache.ibatis.type.ArrayTypeHandler"/>
 		<result property="goods_stock" column="goods_stock"/>
 		<result property="goods_volume" column="goods_volume"/>
 		<result property="goods_income" column="goods_income"/>
 		<result property="goods_grade" column="goods_grade"/>
 		<result property="goods_info" column="goods_info"/>
 		<result property="goods_select" column="goods_select"/>
 		<result property="goods_view" column="goods_view"/>
 		<result property="goods_op1_code" column="goods_op1_code"/>
 		<result property="goods_seq" column="goods_seq"/>
 		<result property="goods_apply_date" column="goods_apply_date"/>
 		<result property="goods_status" column="goods_status"/>
 		<result property="goods_delivery_fee" column="goods_delivery_fee"/>
 	</resultMap>
 	
 	<select id="getReviewBeforeList" parameterType="string" resultMap="goodsOrderDetailResult">
	SELECT * FROM (SELECT ROW_NUMBER() OVER() as rownum, A.* FROM (SELECT
	goods_order_detail.*, goods.goods_name, goods.goods_photo FROM goods_order_detail AS
	goods_order_detail
	LEFT OUTER JOIN goods AS goods ON goods_order_detail.order_detail_goods =
	goods.goods_code)A)AS foo WHERE order_id=#{order_id} AND order_review=false
 	</select>
 	<select id="getReviewBefore" parameterType="string" resultType="goodsOrderDetailVO">
		SELECT * FROM goods_order_detail WHERE order_detail_code=#{order_detail_code}
 	</select>
 	<update id="reviewStateUpdate" parameterType="goodsOrderDetailVO">
 		UPDATE goods_order_detail
 		SET order_review=true WHERE order_detail_code=#{order_detail_code}
 	</update>
 	
 	<!-- 장바구니에서 선택한 상품 결제 페이지에 표시 -->
 	<select id="getCartForOrder" resultType="cartVO" resultMap="cartResult">
 		select c.*, gs.*
			from cart as c
			join goods as gs on c.goods_code = gs.goods_code
		where c.cart_num=#{cart_num}
 	</select>
 	
 	<insert id="insertDetailOrder" parameterType="goodsOrderDetailVO">
 		INSERT INTO goods_order_detail (order_detail_code, order_detail_seller, order_detail_goods, order_detail_quantity, 
 									order_detail_option1, order_detail_donation, order_detail_price,
 									coupon_use, coupon_code, order_detail_cost, order_review, order_id,
 									order_detail_payment, order_goods_name, order_delivery_state,
 									order_date, order_detail_name, order_detail_phone, order_detail_zip,
 									order_detail_address, order_detail_address2, imp_uid )
 							VALUES(#{order_detail_code}, #{order_detail_seller}, #{order_detail_goods}, #{order_detail_quantity},
 									#{order_detail_option}, #{order_detail_donation}, #{order_detail_price}, 
 									#{coupon_use}, #{coupon_code}, #{order_detail_cost}, false, #{order_id},
 									#{order_detail_payment}, #{goods_name}, '배송준비중',
 									now(), #{order_detail_name}, #{order_detail_phone}, #{order_detail_zip},
 									#{order_detail_address}, #{order_detail_address2}, #{imp_uid})		
 	
 	</insert>
 	
 	<select id="getOrderDetailCodes" parameterType="string" resultType="string">
 		SELECT order_detail_code FROM goods_order_detail WHERE order_id=#{email} AND order_date=now()
 	</select>
 	
 	<insert id="insertOrder" parameterType="goodsOrderVO">
 		INSERT INTO goods_order (order_detail_codes, order_payment_date, order_payment_check,
 								order_id, order_save, order_save_use, order_final_cost,
 								marchant_uid, imp_uid)
 						VALUES(#{order_detail_codes, typeHandler=org.apache.ibatis.type.ArrayTypeHandler}, 
 								now(), true, 
 								#{order_id}, #{order_save}, #{order_save_use}, #{order_final_cost}, 
 								#{marchant_uid}, #{imp_uid})
 	</insert>
 	
 	<update id="updateCartNumAfterPayment" parameterType="_int">
 		UPDATE cart SET cart_pay_check=true WHERE cart_num=#{cart_num}
 	</update>
 	
 	<select id="getOrderGoodsList" parameterType="string" resultMap="goodsOrderDetailResult">
 		SELECT * FROM(
			SELECT foo.*, seller.store_name FROM (
			(SELECT goods_order_detail.*, goods.goods_photo FROM goods_order_detail 
				LEFT OUTER JOIN goods 
				ON goods_order_detail.order_detail_goods= goods.goods_code WHERE goods_order_detail.order_id=#{email} AND goods_order_detail.imp_uid NOTNULL
				)AS foo
			LEFT OUTER JOIN seller ON foo.order_detail_seller = seller.seller_code))AS boo
 	</select>
 	
 	<update id="paymentGoodsCancel" parameterType="string">
 		UPDATE goods_order_detail SET order_detail_payment='cancel' WHERE imp_uid=#{imp_uid}
 	</update>
 	<update id="paymentGoodsCancelGoodsOrder" parameterType="string">
 		UPDATE goods_order SET order_payment_check=false WHERE imp_uid=#{imp_uid}
 	</update>
</mapper>