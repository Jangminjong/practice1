<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="CartDAO">
	<resultMap type="cartVO" id="cartResult">
 		<result property="cart_num" column="cart_num"/>
 		<result property="goods_code" column="goods_code"/>
 		<result property="seller_code" column="seller_code"/>
 		<result property="goods_price" column="goods_price"/>
 		<result property="cart_quantity" column="cart_quantity"/>
 		<result property="goods_option_value" column="goods_option_value" typeHandler="org.apache.ibatis.type.ArrayTypeHandler"/>
 		<result property="goods_option_price" column="goods_option_price" typeHandler="org.apache.ibatis.type.ArrayTypeHandler"/>
 		<result property="cart_delivery_fee" column="cart_delivery_fee"/>
 		<result property="cart_donation" column="cart_donation"/>
 		<result property="cart_save" column="cart_save"/>
 		<result property="user_id" column="user_id"/>
 		<result property="cart_pay_check" column="cart_pay_check"/>
 		<result property="cart_order_content" column="cart_order_content"/>
 		<result property="store_name" column="store_name"/>
 		<collection property="goodsVO" resultMap="cartGoodsResult" />
 	</resultMap>
 	
 	<resultMap type="goodsVO" id="cartGoodsResult">
 		<result property="goods_code" column="goods_code"/>
 		<result property="goods_name" column="goods_name"/>
 		<result property="goods_price" column="goods_price"/>
 		<result property="seller_code" column="seller_code"/>
 		<result property="goods_category" column="goods_category"/>
 		<result property="goods_photo" column="goods_photo" typeHandler="org.apache.ibatis.type.ArrayTypeHandler"/>
 		<result property="goods_stock" column="goods_stock"/>
 		<result property="goods_volume" column="goods_volume"/>
 		<result property="goods_income" column="goods_income"/>
 		<result property="goods_grade" column="goods_grade"/>
 		<result property="goods_info" column="goods_info"/>
 		<result property="goods_select" column="goods_select"/>
 		<result property="goods_view" column="goods_view"/>
 		<result property="goods_op1_code" column="goods_op1_code"/>
 		<result property="goods_seq" column="goods_seq"/>
 		<result property="goods_apply_date" column="goods_apply_date"/>
 		<result property="goods_status" column="goods_status"/>
 		<result property="goods_delivery_fee" column="goods_delivery_fee"/>
 		<collection property="goodsOptionVO" resultMap="cartGoodsOptionResult" />
 		<collection property="cartVO" resultMap="cartResult" />
 	</resultMap>
 	
 	<resultMap type="goodsOptionVO" id="cartGoodsOptionResult">
 		<result property="goods_op1_code" column="goods_op1_code"/>
 		<result property="goods_code" column="goods_code"/>
 		<result property="goods_op1_name" column="goods_op1_name"/>
 		<result property="goods_op1_value" column="goods_op1_value" typeHandler="org.apache.ibatis.type.ArrayTypeHandler"/>
 		<result property="goods_op1_price" column="goods_op1_price" typeHandler="org.apache.ibatis.type.ArrayTypeHandler" javaType="Integer[]"/>
 		<collection property="goodsVO" resultMap="cartGoodsResult" />
 	</resultMap>
	
	<!-- 장바구니에서 상품코드 중복확인 -->	
	<select id="goodsCheck" parameterType="cartVO" resultType="_int">
		select count(*) from cart where goods_code=#{goods_code} and user_id=#{user_id}
	</select>
	
	<!-- 상품코드 중복일 시 옵션만 추가 -->
	<update id="updateGoodsOption" parameterType="cartVO">
	</update>
	
	<insert id="insertGoods" parameterType="cartVO">
		insert into cart (goods_code, seller_code, goods_price, cart_quantity, goods_option_value, goods_option_price, user_id, store_name)
		values(#{goods_code}, #{seller_code}, #{goods_price}, #{cart_quantity}, #{goods_option_value, typeHandler=org.apache.ibatis.type.ArrayTypeHandler}, #{goods_option_price, typeHandler=org.apache.ibatis.type.ArrayTypeHandler}, #{user_id}, #{store_name})
	</insert>
	
	<!-- 회원의 장바구니 리스트 가져오기 -->
	<select id="getCartList" resultMap="cartResult">
		select c.*, g.*
			from cart as c
			join goods as g on c.goods_code = g.goods_code 
		where c.user_id = #{user_id}
	</select>
	
	<!-- 수량 + / - -->
	<update id="updateQuantity" parameterType="cartVO">
		update cart set cart_quantity=#{cart_quantity}, goods_price=#{goods_price} where user_id=#{user_id} and goods_code=#{goods_code}
	</update>
	
	<!-- 주문 요청사항 수정 -->
	<update id="updateOrderMessage" parameterType="cartVO">
		update cart set cart_order_content=#{cart_order_content} where user_id=#{user_id} and goods_code=#{goods_code}
	</update>
	
	<!-- 옵션 수정 창 띄우기 -->
	<select id="getGoodsOption" resultMap="cartGoodsOptionResult">
		select go.*, g1.goods_price
			from goods_option1 as go
			join goods as g1 on go.goods_code = g1.goods_code
		where go.goods_code = #{goods_code}
	</select>
	
	<!-- 옵션 수정하기 -->
	<update id="updateOption" parameterType="cartVO">
		update cart set 
			goods_option_value=#{goods_option_value, typeHandler=org.apache.ibatis.type.ArrayTypeHandler},
			goods_option_price=#{goods_option_price, typeHandler=org.apache.ibatis.type.ArrayTypeHandler}, 
			goods_price=#{goods_price}
		where user_id=#{user_id}
	</update>
	
	<!-- 옵션 삭제하기 -->
	<delete id="deleteOption" parameterType="cartVO">
		delete from cart where user_id=#{user_id} and goods_code=#{goods_code}
	</delete>
</mapper>