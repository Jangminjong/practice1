<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="GoodsOrderDAO">
	<resultMap type="goodsOrder" id="goodsOrderResult">
	    <result property="order_detail_code" column="order_detail_code"/>
	 	<result property="order_detail_seller" column="order_detail_seller" />
		<result property="order_detail_goods" column="order_detail_goods"/>
		<result property="order_detail_category" column="order_detail_category" />
		<result property="order_detail_quantity" column="order_detail_quantity" />
		<result property="order_detail_option1" column="order_detail_option1" />
		<result property="order_detail_option2" column="order_detail_option2"/>
		<result property="order_detail_option3" column="order_detail_option3"/>
		<result property="order_detail_donation" column="order_detail_donation"/>
		<result property="order_detail_demand" column="order_detail_demand"/>
		<result property="order_detail_price" column="order_detail_price"/>
		<result property="coupon_use" column="coupon_use"/>
		<result property="coupon_code" column="coupon_code"/>
		<result property="order_detail_cost" column="order_detail_cost"/>
		<result property="order_review" column="order_review"/>
		<result property="order_id" column="order_id"/>
		<result property="order_detail_payment" column="order_detail_payment"/>
		<result property="order_delivery_state" column="order_delivery_state"/>
		<result property="review_goods_code" column="review_goods_code"/>
		<result property="order_date" column="order_date"/>
		<result property="order_goods_name" column="order_goods_name"/>
		<result property="order_detail_name" column="order_detail_name"/>
		<result property="order_detail_phone" column="order_detail_phone"/>
		<result property="order_detail_zip" column="order_detail_zip"/>
		<result property="order_detail_address" column="order_detail_address"/>
		<result property="order_detail_address2" column="order_detail_address2"/>
		<result property="order_detail_status" column="order_detail_status"/>
 	</resultMap>
	<resultMap type="goodsCalc" id="goodsCalcResult">
		<result property="goodsCalcSeq" column="goods_calc_seq"/>
		<result property="goodsCalcSeller" column="goods_calc_seller"/>
		<result property="goodsCalcPrice" column="goods_calc_price"/>
		<result property="goodsCalcDonation" column="goods_calc_donation"/>
		<result property="goodsCalcCommission" column="goods_calc_commission"/>
		<result property="goodsCalcResultMoney" column="goods_calc_result_money"/>
		<result property="goodsCalcDate" column="goods_calc_date"/>
	</resultMap>
	
	
	<!-- 주문 상세조회 -->
	<select id="Order" resultType="goodsOrder" resultMap="goodsOrderResult">
		SELECT * FROM goods_order_detail WHERE order_detail_code=#{order_detail_code}
	</select>
	
	<!-- 배송 수정 -->
	 <update id="updateOrder" parameterType="com.idwith.mpweb.writer.order.GoodsOrderVO">
	 	<![CDATA[	
	 		UPDATE goods_order_detail
	 		SET order_delivery_state=#{order_delivery_state}
	 		WHERE order_detail_code = #{order_detail_code}
	    ]]> 	 
 	</update>

	<!-- 페이징 처리 후 게시글 조회 -->
	<select id="getOrderList" parameterType="com.idwith.mpweb.common.PagingVO" resultMap="goodsOrderResult">
		<![CDATA[
			SELECT * FROM (
				SELECT ROW_NUMBER() OVER() as rownum, A.* FROM (SELECT *
			FROM goods_order_detail WHERE order_detail_seller=#{countNotice} ORDER BY order_detail_code DESC)A)AS foo WHERE rownum BETWEEN #{start} AND #{end}
		]]>
	</select>	

     <!-- 해당 작가의 게시글 개수 출력 -->
	<select id="countGoodsOrder" resultType="int">
		select count(*) from goods_order_detail WHERE order_detail_seller=#{sellerCode}
	</select>
	
	<!--  당일 주문수 출력 -->
	<select id="countTodayOrder" resultType="int">
	   select count(*) from goods_order_detail WHERE order_detail_seller=#{sellerCode} and order_date=current_date
	</select>
	

	<select id="getGoodsOrderListFive" resultMap="goodsOrderResult">
		select * from goods_order_detail WHERE order_detail_seller=#{sellerCode} limit 5
	</select>
	
	<!--  정산신청시 상태값 변경 -->
	<update id="goodsUpdateStatusCalcReq">
		update goods_order_detail set order_detail_status=1 where order_detail_code = #{goodsCode}
	</update>
	
	<!-- 주문 정산 신청한 개수 조회 -->
	<select id="countGoodsOrderAll" resultType="_int">
		select count(*) from goods_order_detail WHERE order_detail_status = 1
	</select>
	
	<!-- 페이징 처리 후 주문 전체 게시글 조회 -->
	<select id="getOrderListAll" parameterType="com.idwith.mpweb.common.PagingVO" resultMap="goodsOrderResult">
		<![CDATA[
			SELECT * FROM (
				SELECT ROW_NUMBER() OVER() as rownum, A.* FROM (SELECT *
			FROM goods_order_detail WHERE order_detail_status=1 ORDER BY order_detail_code DESC)A)AS foo WHERE rownum BETWEEN #{start} AND #{end}
		]]>
	</select>
	
	<update id="goodsUpdateStatusCalcRes">
		update goods_order_detail set order_detail_status=2 where order_detail_code = #{goodsCode}
	</update>
	
	<select id="getGoodsOrderOne" resultType="goodsOrder" resultMap="goodsOrderResult">
		SELECT * FROM goods_order_detail WHERE order_detail_code=#{goods_Code}
	</select>
	
	<insert id="insertGoodsCalc" parameterType="goodsCalc">
		INSERT INTO goods_calc(goods_calc_seller, goods_calc_price, goods_calc_donation, goods_calc_commission, goods_calc_result_money)
		values(#{goodsCalcSeller}, #{goodsCalcPrice}, #{goodsCalcDonation}, #{goodsCalcCommission}, #{goodsCalcResultMoney})
	</insert>
	
	<!-- 매출  -->
	<!-- 일주일간 주문수량 -->
	<select id="getGoodsCountFive" parameterType="_int" resultType="_int">
		SELECT sum(order_detail_quantity) from goods_order_detail WHERE order_detail_seller = #{seller}
		AND order_date BETWEEN (current_date - '7 day'::interval)::date AND current_date
		GROUP BY order_detail_goods order by sum(order_detail_price * order_detail_quantity) desc limit 5
	</select>
	<!-- 일주일간 판매금액 -->
	<select id="getGoodsSalesFive" parameterType="_int" resultType="_int">
		SELECT sum(order_detail_price * order_detail_quantity) from goods_order_detail WHERE order_detail_seller = #{seller}
		AND order_date BETWEEN (current_date - '7 day'::interval)::date AND current_date
		GROUP BY order_detail_goods order by sum(order_detail_price * order_detail_quantity) desc limit 5
	</select>
	
	<!-- 일주일간 매출 순위 5위 내 상품명 -->
	<select id="getGoodsNameFive" parameterType="_int" resultType="string">
		SELECT order_goods_name from goods_order_detail WHERE order_detail_seller = #{seller}
		AND order_date BETWEEN (current_date - '7 day'::interval)::date AND current_date
		GROUP BY order_goods_name order by sum(order_detail_price * order_detail_quantity) desc limit 5
	</select>
	
	<!-- 일주일간 순위 5위 내 작품코드 -->
	<select id="getGoodsCodeFive" parameterType="_int" resultType="string">
		SELECT order_detail_goods from goods_order_detail WHERE order_detail_seller = #{seller}
		AND order_date BETWEEN (current_date - '7 day'::interval)::date AND current_date
		GROUP BY order_detail_goods order by sum(order_detail_price * order_detail_quantity) desc limit 5
	</select>
	
	
	<!-- 작가메인화면 -->
	<select id="yesterdayOrder" resultType="_int">
		SELECT count(*) from goods_order_detail WHERE order_detail_seller = #{sellerCode}
		AND order_date = (current_date - '1 day'::interval)::date
	</select>
	
	<select id="weekOrder" resultType="_int">
		SELECT count(*) from goods_order_detail WHERE order_detail_seller = #{sellerCode}
		AND order_date BETWEEN (current_date - '7 day'::interval)::date AND current_date
	</select>
	<select id="todaySales" resultType="_int">
	SELECT sum(order_detail_price * order_detail_quantity) from goods_order_detail WHERE order_detail_seller = #{sellerCode}
		AND order_date = current_date
	</select>
	<select id="yesterdaySales" resultType="_int">
	SELECT sum(order_detail_price * order_detail_quantity) from goods_order_detail WHERE order_detail_seller = #{sellerCode}
		AND order_date = (current_date - '1 day'::interval)::date
	</select>
	<select id="weekSales" resultType="_int">
	SELECT sum(order_detail_price * order_detail_quantity) from goods_order_detail WHERE order_detail_seller = #{sellerCode}
		AND order_date BETWEEN (current_date - '7 day'::interval)::date AND current_date
	</select>
	
	<!-- 전체 매출 -->
	<!-- 일일 매출 -->
	<select id="todayAllSales" resultType="_int">
		select sum(order_detail_price * order_detail_quantity) from goods_order_detail WHERE order_date = current_date
	</select>
	<!-- 한달 매출 -->
	<select id="monthAllSales" resultType="_int">
		select sum(order_detail_price * order_detail_quantity) from goods_order_detail
		WHERE order_date BETWEEN (current_date - '30 day'::interval)::date AND current_date
	</select>
	
	<!-- 지정된 날짜 사이의 매출 -->
	<select id="getRangeCalc" parameterType="goodsOrder" resultType="int">
		SELECT sum(order_detail_price * order_detail_quantity) from goods_order_detail
		WHERE order_date BETWEEN #{startDate} and #{endDate} group by order_date order by order_date desc	
	</select>
	<select id="getRangeDate" parameterType="goodsOrder" resultType="date">
	SELECT order_date from goods_order_detail
		WHERE order_date BETWEEN #{startDate} and #{endDate} group by order_date order by order_date desc
	</select>
</mapper>